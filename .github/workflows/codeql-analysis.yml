# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
name: "CodeQL"

# Disable this workflow since GitHub default CodeQL setup is enabled
# This prevents the conflict: "CodeQL analyses from advanced configurations cannot be processed when the default setup is enabled"
on:
  # Commented out triggers to prevent this workflow from running
  # push:
  #   branches: [ master, main ]
  # pull_request:
  #   # The branches below must be a subset of the branches above
  #   branches: [ master, main ]
  # schedule:
  #   - cron: '26 22 * * 4'
  
  # This workflow will only run manually, when explicitly triggered
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
        # CodeQL supports [ 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby', 'swift' ]
        # Use only 'javascript' to analyze JS/TS files

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        # queries: ./path/to/local/query, your-org/your-repo/queries@main

    # Install dependencies and build the project instead of using autobuild
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        
    - name: Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: Build project for CI
      run: yarn build:ci
      env:
        NODE_OPTIONS: '--openssl-legacy-provider'

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"

# Note: This workflow has been disabled to prevent conflicts with GitHub's default CodeQL setup.
# The error "CodeQL analyses from advanced configurations cannot be processed when the default setup is enabled"
# occurs when both custom and default configurations try to run simultaneously.
# 
# Options to resolve this issue:
# 1. Keep this workflow disabled and use GitHub's default CodeQL setup (current approach)
# 2. Re-enable this workflow and disable the default setup in GitHub repository settings
